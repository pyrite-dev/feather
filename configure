#!/bin/sh
PREFIX="/usr/fhttpd"
TARGET="`uname -s`"
EMBED="dso"
SSL="define"

for i in "$@"; do
	case "$i" in
		--prefix=*)
			PREFIX="`echo "$i" | cut -d= -f2-`"
			;;
		--target=*)
			TARGET="`echo "$i" | cut -d= -f2-`"
			;;
		--enable-*)
			eval `echo "$i" | cut -d- -f4 | tr "[:lower:]" "[:upper:]"`="define"
			;;
		--disable-*)
			eval `echo "$i" | cut -d- -f4 | tr "[:lower:]" "[:upper:]"`="undef"
			;;
		*)
			echo "Invalid argument"
			exit 1
			;;
	esac
done

cat > config.mk << EOF
PREFIX	= $PREFIX

# Modules to embed
EMBED	= $EMBED

# DSO modules to compile
MODULES = 

AR	= ar
ARFLAGS	= rcs
CC 	= cc
CFLAGS	=
LDFLAGS =
LIBS	=

# Compiler flag for Position Independent Code
PIC	= -fPIC

# Compiler flag to include directory
INCDIR	= -I

# Compiler flag to define macro
DEFINE	= -D

# Compiler flag to link library
LINK	= -l

# Linker flag for rpath
RPATH	= -Wl,-R\$(PREFIX)/lib

# Linker flag to include directory
LIBDIR =  -L

# Linker flag for SSL library
SSL	=

# Linker flag for FPR
FPR	= \$(LINK)fpr

# Linker flag for dynamic library
SHARED	= -shared

# Prefix for library
LIB	= lib

# Extension for archive
A	= .a

# Extension for DSO
SO	= .so

# Extension for object
O	= .o

# Extension for executable
E	=

### Appended automatically - target $TARGET
EOF
if [ -f "mk/ostype/$TARGET.mk" ]; then
	cat mk/ostype/$TARGET.mk >> config.mk
fi
cat >> config.mk << EOF

### Additional settings
EOF
if [ "$SSL" = "define" ]; then
	echo "SSL	= \$(LINK)ssl \$(LINK)crypto" >> config.mk
fi

cat > config.h << EOF
#ifndef __CONFIG_H__
#define __CONFIG_H__

#define PREFIX "$PREFIX"

/* SSL support */
#$SSL HAS_SSL

/* change them if your platform is not supported
 * ... and send us patch for your platform :)
 */
#undef HAS_IPV6
#undef HAS_POLL
#undef HAS_FORK
#undef HAS_UNIX_SOCKET

/* this decides buffer size for config file and HTTP */
#define BUFFER_SIZE 1024

/* this decides how long line can be in config file */
#define LINE_SIZE BUFFER_SIZE

/* max length stuff - this does not include NUL terminator */
#define MAX_METHOD_LENGTH 128
#define MAX_PATH_LENGTH 1024
#define MAX_QUERY_LENGTH 1024
#define MAX_VERSION_LENGTH 8 /* you DO NOT have to change this... */

/* Modules to embed - also edit config.mk */
#define MODULES \\
EOF
for i in "$EMBED"; do
	echo "	LOAD($i) \\" >> config.h
done
cat >> config.h << EOF

/*
 * /!\ DO NOT CHANGE LINES BELOW THIS LINE /!\
 * /!\     UNLESS YOU ARE A MAINTAINER     /!\
 */

/* Windows */
#if defined(_WIN32)
#define HAS_IPV6
#endif

/* NetBSD/OpenBSD/FreeBSD/Linux */
#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__) || defined(__linux__)
#define HAS_IPV6
#define HAS_POLL
#define HAS_FORK
#define HAS_UNIX_SOCKET
#endif

#endif
EOF
