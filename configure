#!/bin/sh
PREFIX="/usr/fhttpd"
TARGET="`uname -s`"
EMBED="dso"
SSLopt="define"

AR='ar'
ARFLAGS='rcs'
CC='cc'
CFLAGS=''
RC='windres'
RCFLAGS=''

RPATH='-Wl,-R$(PREFIX)/lib'

SSL=''
FPR='$(LINK)fpr'

A='.a'
SO='.so'
O='.o'
E=''

RESFILE=''

AFTER=''

for i in "$@"; do
	case "$i" in
		--prefix=*)
			PREFIX="`echo "$i" | cut -d= -f2-`"
			;;
		--target=*)
			TARGET="`echo "$i" | cut -d= -f2-`"
			;;
		--enable-*)
			eval `echo "$i" | cut -d- -f4 | tr "[:lower:]" "[:upper:]"`opt="define"
			;;
		--disable-*)
			eval `echo "$i" | cut -d- -f4 | tr "[:lower:]" "[:upper:]"`opt="undef"
			;;
		*)
			echo "Invalid argument"
			exit 1
			;;
	esac
done

if [ -f "ostype/$TARGET.sh" ]; then
	. ostype/$TARGET.sh
fi

if [ "$SSLopt" = "define" ]; then
	SSL='$(LINK)ssl $(LINK)crypto'
fi

cat > config.mk << EOF
PREFIX	= $PREFIX

# Modules to embed
EMBED	= $EMBED

# DSO modules to compile
MODULES = 

AR	= $AR
ARFLAGS	= $ARFLAGS
CC 	= $CC
CFLAGS	= $CFLAGS
RC	= $RC
RCFLAGS	= $RCFLAGS
LDFLAGS = $LDFLAGS
LIBS	= $LIBS

# Compiler flag for Position Independent Code
PIC	= -fPIC

# Compiler flag to include directory
INCDIR	= -I

# Compiler flag to define macro
DEFINE	= -D

# Compiler flag to link library
LINK	= -l

# Linker flag for rpath
RPATH	= $RPATH

# Linker flag to include directory
LIBDIR =  -L

# Linker flag for SSL library
SSL	= $SSL

# Linker flag for FPR
FPR	= $FPR

# Linker flag for dynamic library
SHARED	= -shared

# Prefix for library
LIB	= lib

# Extension for archive
A	= $A

# Extension for DSO
SO	= $SO

# Extension for object
O	= $O

# Extension for executable
E	= $E

# Resource file output
RESFILE	= $RESFILE

# Commands to be ran after building
AFTER	= $AFTER
EOF

cat > config.h << EOF
#ifndef __CONFIG_H__
#define __CONFIG_H__

#define PREFIX "$PREFIX"

/* SSL support */
#$SSLopt HAS_SSL

/* change them if your platform is not supported
 * ... and send us patch for your platform :)
 */
#undef HAS_IPV6
#undef HAS_POLL
#undef HAS_FORK
#undef HAS_UNIX_SOCKET

/* this decides buffer size for config file and HTTP */
#define BUFFER_SIZE 1024

/* this decides how long line can be in config file */
#define LINE_SIZE BUFFER_SIZE

/* max length stuff - this does not include NUL terminator */
#define MAX_METHOD_LENGTH 128
#define MAX_PATH_LENGTH 1024
#define MAX_QUERY_LENGTH 1024
#define MAX_VERSION_LENGTH 8 /* you DO NOT have to change this... */

/* Modules to embed - also edit config.mk */
#define MODULES \\
EOF
for i in "$EMBED"; do
	echo "	LOAD($i) \\" >> config.h
done
cat >> config.h << EOF

/*
 * /!\ DO NOT CHANGE LINES BELOW THIS LINE /!\
 * /!\     UNLESS YOU ARE A MAINTAINER     /!\
 */

/* Windows */
#if defined(_WIN32)
#define HAS_IPV6
#endif

/* NetBSD/OpenBSD/FreeBSD/Linux */
#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__) || defined(__linux__)
#define HAS_IPV6
#define HAS_POLL
#define HAS_FORK
#define HAS_UNIX_SOCKET
#endif

#endif
EOF
